title: "U.S. Military Base Slot Machine Revenue Explorer"
description: >
  Interactive Datasette deployment that surfaces FY2020-FY2024 slot machine
  revenue reported by U.S. military installations worldwide. Built from
  MuckRock FOIA responses and enriched with geocoded coordinates for mapping.
source: "MuckRock FOIA Request"
license: "Creative Commons Attribution 4.0"
about: "Datasette instance prepared for the DS 701 project team."
databases:
  military_slots:
    title: "Military Slot Machine Revenue (FY20-FY24)"
    description: >
      Monthly slot machine revenue for Army, Navy, and Marine Corps morale,
      welfare, and recreation (MWR) facilities aligned to fiscal years 2020
      through 2024 with coordinates for each installation.
    tables:
      slot_machine_revenue:
        title: "Slot Machine Revenue by Installation"
        description: >
          Each row represents the revenue reported by a specific facility on a
          military installation for a given fiscal month. Fiscal years follow
          the U.S. federal calendar (Oct-Sep).
        source: "U.S. military MWR slot machine financial disclosures"
        columns:
          installation_name: "Official installation name reported in the FOIA response."
          facility_name: "Name of the club, community center, or other venue housing the slot machines."
          branch: "Military branch responsible for the facility (Army, Navy, USMC)."
          district: "Geographic district or theater (e.g., Japan, Europe, Korea)."
          category: "Reported ledger category (Revenue or Expense)."
          calendar_year: "Calendar year for the entry as provided in the PDF."
          fiscal_year: "U.S. federal fiscal year that the month rolls up to (Oct-Sep)."
          month_name: "Name of the month for the record."
          month_number: "Integer month number (1-12) used for ordering."
          revenue: "Total slot machine revenue in U.S. dollars."
          base_latitude: "Installation latitude for mapping."
          base_longitude: "Installation longitude for mapping."
        sort_desc: revenue
        facets:
          - branch
          - district
          - fiscal_year
          - installation_name
        plugins:
          datasette-cluster-map:
            latitude_column: base_latitude
            longitude_column: base_longitude
      marine_revenue_detail:
        title: "Marine Corps Revenue Detail (FY20-FY24)"
        description: "Line-level Marine Corps slot revenue with coordinates."
        columns:
          page: "Page number from the source PDF."
          loc_id: "Marine facility location identifier."
          base_name: "Name of the Marine base."
          location_name: "Name of the Marine location."
          month_label: "Month label from the source (e.g., 17-Oct)."
          revenue: "Reported revenue amount."
          nafi_amount: "NAFI amount."
          annual_revenue: "Annual revenue total if provided."
          annual_nafi: "Annual NAFI total if provided."
          base_latitude: "Latitude coordinate for the location."
          base_longitude: "Longitude coordinate for the location."
        sort_desc: revenue
        facets:
          - location_name
          - month_label
        plugins:
          datasette-cluster-map:
            latitude_column: base_latitude
            longitude_column: base_longitude
    queries:
      branch_revenue_summary:
        title: "Branch Revenue Overview"
        description: "Counts installations and aggregates revenue per branch."
        sql: &branch_revenue_summary_sql |
          select
            branch,
            count(distinct installation_name) as installations,
            round(sum(revenue), 2) as total_revenue,
            round(avg(revenue), 2) as avg_monthly_revenue
          from slot_machine_revenue
          group by branch
          order by total_revenue desc;
      top_installations:
        title: "Top 10 Installations by Revenue"
        description: "Shows the highest grossing installations across the full timeframe."
        sql: &top_installations_sql |
          select
            installation_name,
            branch,
            district,
            round(sum(revenue), 2) as total_revenue
          from slot_machine_revenue
          group by installation_name, branch, district
          order by total_revenue desc
          limit 10;
      fiscal_trends:
        title: "Revenue Trends by Fiscal Year and Branch"
        description: "Breaks out aggregate revenue per fiscal year and branch."
        sql: &fiscal_trends_sql |
          select
            fiscal_year,
            branch,
            round(sum(revenue), 2) as total_revenue
          from slot_machine_revenue
          group by fiscal_year, branch
          order by fiscal_year desc, total_revenue desc;
      revenue_by_district:
        title: "Revenue by District"
        description: "Aggregates total revenue and installation counts per geographic district."
        sql: |
          select
            district,
            count(distinct installation_name) as installations,
            round(sum(revenue), 2) as total_revenue
          from slot_machine_revenue
          group by district
          order by total_revenue desc;
      branch_district_revenue:
        title: "Branch vs District Revenue and Per-Base Average"
        description: "Total revenue, base counts, and per-base averages grouped by branch and district."
        sql: &branch_district_revenue_sql |
          select
            branch,
            district,
            count(distinct installation_name) as installations,
            round(sum(revenue), 2) as total_revenue,
            round(sum(revenue) / count(distinct installation_name), 2) as revenue_per_base
          from slot_machine_revenue
          group by branch, district
          order by branch, total_revenue desc;
      top_bases_by_year_branch:
        title: "Top Bases by Fiscal Year and Branch"
        description: "Ranks installations within each fiscal year and branch by total revenue."
        sql: &top_bases_by_year_branch_sql |
          with totals as (
            select
              installation_name,
              branch,
              fiscal_year,
              round(sum(revenue), 2) as total_revenue
            from slot_machine_revenue
            where fiscal_year is not null
            group by installation_name, branch, fiscal_year
          )
          select
            installation_name,
            branch,
            fiscal_year,
            total_revenue,
            rank() over (partition by branch, fiscal_year order by total_revenue desc) as rank_in_branch_year
          from totals
          order by fiscal_year desc, branch, rank_in_branch_year
          limit 200;
plugins:
  datasette-vega: {}
  datasette-dashboards:
    slot_machine_overview:
      title: "Slot Machine Revenue Overview"
      description: "Key metrics, geographies, trends, and top installations from FY2020-FY2024."
      settings:
        allow_fullscreen: true
      filters:
        fiscal_year:
          type: select
          name: Fiscal Year
          db: military_slots
          query: "select distinct fiscal_year from slot_machine_revenue where fiscal_year is not null order by fiscal_year desc"
        branch:
          type: select
          name: Branch
          db: military_slots
          query: "select distinct branch from slot_machine_revenue where branch is not null order by branch"
        district:
          type: select
          name: District
          db: military_slots
          query: "select distinct district from slot_machine_revenue where district is not null order by district"
      charts:
        snapshot:
          title: "Project Snapshot"
          library: markdown
          display: |
            ### Project Snapshot
            - Data source: MuckRock FOIA responses (Army, Navy, USMC)
            - Coverage: Fiscal Years 2020-2024
            - Plugins: datasette-cluster-map, datasette-vega, datasette-dashboards
        total_revenue_metric:
          title: "Total Revenue"
          library: metric
          db: military_slots
          query: |
            select round(sum(revenue), 0) as total_revenue
            from slot_machine_revenue
            where 1=1
              [[and fiscal_year = :fiscal_year]]
              [[and branch = :branch]]
              [[and district = :district]]
          display:
            field: total_revenue
            prefix: "$"
        revenue_over_time_chart:
          title: "Revenue by Month"
          library: vega-lite
          db: military_slots
          query: |
            select
              month_number,
              month_name,
              branch,
              round(sum(revenue), 2) as total_revenue
            from slot_machine_revenue
            where 1=1
              [[and fiscal_year = :fiscal_year]]
              [[and branch = :branch]]
              [[and district = :district]]
            group by month_number, month_name, branch
            order by month_number;
          display:
            mark: line
            encoding:
              x:
                field: month_number
                type: ordinal
                axis: { title: "Month" }
              y:
                field: total_revenue
                type: quantitative
                axis: { title: "Revenue" }
              color:
                field: branch
                type: nominal
              tooltip:
                - field: fiscal_year
                - field: month_name
                - field: branch
                - field: total_revenue
        branch_district_heatmap:
          title: "Branch vs District Heatmap"
          library: vega-lite
          db: military_slots
          query: |
            select
              branch,
              district,
              count(distinct installation_name) as installations,
              round(sum(revenue), 2) as total_revenue,
              round(sum(revenue) / count(distinct installation_name), 2) as revenue_per_base
            from slot_machine_revenue
            where 1=1
              [[and fiscal_year = :fiscal_year]]
              [[and branch = :branch]]
              [[and district = :district]]
            group by branch, district
            order by branch, total_revenue desc;
          display:
            mark: rect
            encoding:
              x:
                field: district
                type: nominal
              y:
                field: branch
                type: nominal
              color:
                field: total_revenue
                type: quantitative
                scale:
                  scheme: blues
              tooltip:
                - field: branch
                - field: district
                - field: installations
                - field: total_revenue
                - field: revenue_per_base
            width: 180
            height: 240
        fiscal_year_trends:
          title: "Fiscal-Year Trends"
          library: vega-lite
          db: military_slots
          query: |
            select
              fiscal_year,
              branch,
              round(sum(revenue), 2) as total_revenue
            from slot_machine_revenue
            where 1=1
              [[and fiscal_year = :fiscal_year]]
              [[and branch = :branch]]
              [[and district = :district]]
            group by fiscal_year, branch
            order by fiscal_year desc, total_revenue desc;
          display:
            mark: line
            encoding:
              x:
                field: fiscal_year
                type: ordinal
              y:
                field: total_revenue
                type: quantitative
              color:
                field: branch
                type: nominal
              tooltip:
                - field: fiscal_year
                - field: branch
                - field: total_revenue
        top_installations_table:
          title: "Top 10 Installations"
          library: vega-lite
          db: military_slots
          query: |
            select
              installation_name,
              branch,
              district,
              round(sum(revenue), 2) as total_revenue
            from slot_machine_revenue
            where 1=1
              [[and fiscal_year = :fiscal_year]]
              [[and branch = :branch]]
              [[and district = :district]]
            group by installation_name, branch, district
            order by total_revenue desc
            limit 10;
          display:
            mark: bar
            encoding:
              x:
                field: total_revenue
                type: quantitative
              y:
                field: installation_name
                type: nominal
                sort: "-x"
              color:
                field: branch
                type: nominal
              tooltip:
                - field: installation_name
                - field: branch
                - field: district
                - field: total_revenue
            width: 360
            height: 280
        map_overview:
          title: "Installations Map"
          library: map
          db: military_slots
          query: |
            select
              installation_name,
              branch,
              district,
              round(sum(revenue), 2) as total_revenue,
              base_latitude,
              base_longitude
            from slot_machine_revenue
            where base_latitude is not null and base_longitude is not null
              [[and fiscal_year = :fiscal_year]]
              [[and branch = :branch]]
              [[and district = :district]]
            group by installation_name, branch, district, base_latitude, base_longitude
          display:
            latitude_column: base_latitude
            longitude_column: base_longitude
            show_latlng_popup: false
        branch_totals_pie:
          title: "Branch Revenue Share"
          library: vega-lite
          db: military_slots
          query: |
            select
              branch,
              round(sum(revenue), 2) as total_revenue
            from slot_machine_revenue
            where 1=1
              [[and fiscal_year = :fiscal_year]]
              [[and branch = :branch]]
              [[and district = :district]]
            group by branch
            order by total_revenue desc;
          display:
            mark:
              type: arc
              innerRadius: 50
              outerRadius: 100
            encoding:
              theta:
                field: total_revenue
                type: quantitative
              color:
                field: branch
                type: nominal
              tooltip:
                - field: branch
                - field: total_revenue
            width: 240
            height: 220
        
      layout:
        - [snapshot, map_overview, map_overview, total_revenue_metric]
        - [snapshot, revenue_over_time_chart, revenue_over_time_chart, branch_district_heatmap]
        - [fiscal_year_trends, top_installations_table, top_installations_table, branch_totals_pie]
